const SDVariable = require("../../../classes/variable/SpecialDevice/SDVariable");
const SpecialDevice = require("../../../classes/device/SpecialDevices/SpecialDevice");
const config = require("config");
const { clearDirectoryAsync } = require("../../../utilities/utilities");
let testPayload = JSON.stringify({
  "1234": {
    id: "1234",
    name: "test device 1",
    isActive: false,
    timeout: 2000,
    ipAdress: "192.168.0.1",
    unitId: 1,
    portNumber: 502,
    variables: [
      {
        id: "0001",
        timeSample: 2,
        name: "test variable 1",
        offset: 5,
        length: 1,
        fCode: 3,
        value: 1,
        type: "mbInt16",
        archived: false,
        getSingleFCode: 3,
        setSingleFCode: 16,
        unit: "unit1"
      },
      {
        id: "0002",
        timeSample: 3,
        name: "test variable 2",
        offset: 6,
        length: 2,
        fCode: 4,
        value: 2,
        type: "mbInt32",
        archived: true,
        getSingleFCode: 4,
        setSingleFCode: 16,
        unit: "unit2"
      },
      {
        id: "0003",
        timeSample: 4,
        name: "test variable 3",
        offset: 7,
        length: 2,
        fCode: 16,
        value: 3.3,
        type: "mbFloat",
        archived: false,
        getSingleFCode: 3,
        setSingleFCode: 16,
        unit: "unit3"
      }
    ],
    calculationElements: [
      {
        id: "1001",
        type: "sumElement",
        archived: true,
        sampleTime: 1,
        name: "sumElement1",
        unit: "A",
        variables: [
          {
            id: "0001",
            factor: 1
          },
          {
            id: "0002",
            factor: 2
          }
        ]
      },
      {
        id: "1002",
        type: "sumElement",
        archived: true,
        sampleTime: 2,
        unit: "B",
        name: "sumElement2",
        variables: [
          {
            id: "0002",
            factor: 2
          },
          {
            id: "0003",
            factor: 3
          }
        ]
      }
    ],
    type: "mbDevice"
  },
  "1235": {
    id: "1235",
    name: "test device 2",
    isActive: false,
    timeout: 2000,
    ipAdress: "192.168.0.2",
    unitId: 1,
    portNumber: 502,
    variables: [
      {
        id: "0004",
        timeSample: 2,
        name: "test variable 4",
        offset: 5,
        length: 1,
        fCode: 1,
        value: true,
        type: "mbBoolean",
        archived: true,
        getSingleFCode: 1,
        setSingleFCode: 15,
        unit: "unit4"
      },
      {
        id: "0005",
        timeSample: 3,
        name: "test variable 5",
        offset: 6,
        length: 2,
        fCode: 4,
        value: 5,
        type: "mbSwappedInt32",
        archived: true,
        getSingleFCode: 4,
        setSingleFCode: 16,
        unit: "unit5"
      },
      {
        id: "0006",
        timeSample: 4,
        name: "test variable 6",
        offset: 7,
        length: 2,
        fCode: 16,
        value: 6.6,
        type: "mbSwappedFloat",
        archived: true,
        getSingleFCode: 3,
        setSingleFCode: 16,
        unit: "unit6"
      }
    ],
    type: "mbDevice"
  },
  "1236": {
    id: "1236",
    name: "test device 3",
    isActive: false,
    timeout: 2000,
    ipAdress: "192.168.0.3",
    unitId: 1,
    portNumber: 502,
    variables: [
      {
        id: "0007",
        timeSample: 2,
        name: "test variable 4",
        offset: 4,
        length: 1,
        fCode: 3,
        value: 7,
        type: "mbUInt16",
        archived: false,
        getSingleFCode: 3,
        setSingleFCode: 16,
        unit: "unit7"
      },
      {
        id: "0008",
        timeSample: 3,
        name: "test variable 5",
        offset: 5,
        length: 2,
        fCode: 4,
        value: 8,
        type: "mbSwappedUInt32",
        archived: true,
        getSingleFCode: 4,
        setSingleFCode: 16,
        unit: "unit8"
      },
      {
        id: "0009",
        timeSample: 4,
        name: "test variable 6",
        offset: 7,
        length: 2,
        fCode: 3,
        value: 9,
        type: "mbUInt32",
        archived: false,
        getSingleFCode: 3,
        setSingleFCode: 16,
        unit: "unit9"
      }
    ],
    calculationElements: [
      {
        id: "3001",
        type: "sumElement",
        archived: true,
        sampleTime: 1,
        name: "sumElement1",
        unit: "C",
        variables: [
          {
            id: "0007",
            factor: 1
          },
          {
            id: "0008",
            factor: 2
          }
        ]
      },
      {
        id: "3002",
        type: "sumElement",
        archived: true,
        sampleTime: 2,
        name: "sumElement2",
        unit: "D",
        variables: [
          {
            id: "0008",
            factor: 2
          },
          {
            id: "0009",
            factor: 3
          }
        ]
      }
    ],
    type: "mbDevice"
  }
});

describe("SDVariable", () => {
  let db1Path;
  let db2Path;
  let initPayload;
  let fakeDevice;
  let commInterface;

  //Creating seperate commInterface to all tests
  beforeEach(async () => {
    jest.resetModules();
    commInterface = require("../../../classes/commInterface/CommInterface.js");
    db1Path = config.get("db1Path");
    db2Path = config.get("db2Path");
    fakeDevice = "fakeDevice";
    initPayload = JSON.parse(testPayload);
    await commInterface.init(initPayload);
  });

  afterEach(async () => {
    if (commInterface.Initialized) {
      //ending communication with all devices if there are any
      await commInterface.stopCommunicationWithAllDevices();
      commInterface.Sampler.stop();
    }

    //waiting for all sampling actions to end being invoke;
    await clearDirectoryAsync(db1Path);
    await clearDirectoryAsync(db2Path);

    jest.resetModules();
  });

  describe("constructor", () => {
    let exec = () => {
      return new SDVariable(fakeDevice);
    };

    it("should assign device to Device object", () => {
      let result = exec();
      expect(result.Device).toBeDefined();
      expect(result.Device).toEqual(fakeDevice);
    });

    it("should assign commInterface to variable", () => {
      let result = exec();
      expect(result.CommInterface).toBeDefined();
      expect(result.CommInterface).toEqual(commInterface);
    });
  });

  describe("init", () => {
    let initialPayload;

    beforeEach(() => {
      initialPayload = {
        name: "testSpecialDevice",
        id: "987654321",
        timeSample: 5,
        archived: true,
        unit: 15,
        archiveTimeSample: 10,
        elementDeviceId: "1235"
      };
    });

    let exec = () => {
      return new SDVariable(fakeDevice);
    };

    it("should assign device to Device object", () => {
      let result = exec();
      expect(result.Device).toBeDefined();
      expect(result.Device).toEqual(fakeDevice);
    });

    it("should assign commInterface to variable", () => {
      let result = exec();
      expect(result.CommInterface).toBeDefined();
      expect(result.CommInterface).toEqual(commInterface);
    });
  });
});
